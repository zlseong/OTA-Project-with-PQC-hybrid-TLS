# 2. Request VCI (Server → VMG)

**Spec:** Server → VMG (prototype)

- Format: JSON (flat)
- Purpose: Instruct VMG to send VCI (vehicle configuration/inventory)

## Minimal fields
- `msg_id` *(string, required)* — unique ID (e.g., `SRV_MSG_0001`)
- `proto_ver` *(string, required)* — e.g., `"1.0"`
- `type` *(string, required)* — fixed: `"RequestVCI"`
- `vehicle_id` *(string, required)* — e.g., `VEH_001`
- `gateway_id` *(string, required)* — e.g., `CCU_001`
- `fields` *(array[string], required)* — specific fields to include in VCI response
- `correlation_id` *(string, optional)* — link to prior message

## Correlation ID Usage
- **Purpose**: Links this message to a previous message for request-response matching
- **Value**: Copy the `msg_id` from the triggering message
- **Usage**: Request↔Response matching, retry/duplicate detection, chunk sequence linking, long-term operation result attribution
- **Server Validation**: Verify `correlation_id` matches a valid `msg_id` sent by server, reject if expired (expires_at_ms/deadline_s)
- `deadline_s` *(uint, optional)* — response deadline (seconds from reference time)
- `ts` *(int64, epoch_ms UTC, optional)* — send time (epoch ms UTC)
- `expires_at_ms` *(int64, epoch_ms, optional)* — absolute expiry timestamp
- `reason` *(string, optional)* — purpose/context

## Example
```json
{
  "msg_id": "SRV_MSG_0001",
  "proto_ver": "1.0",
  "type": "RequestVCI",
  "vehicle_id": "VEH_001",
  "gateway_id": "CCU_001",
  "fields": [
    "ecu_id",           // ECU identifier (e.g., "ecu_001", "ecu_002", ..., "ecu_100")
    "supplier_code",    // Supplier/manufacturer code (e.g., "1234", "5678")
    "hw_part_no",       // Hardware part number (e.g., "HW-PT-0001")
    "sw_part_no",       // Software part number (e.g., "SW-PT-4711")
    "sw_version",       // Current software version (e.g., "3.2.5")
    "calibration_id",  // Region/country-specific calibration ID (e.g., "KR-IVI-2025Q1")
    "bootloader_ver",   // Bootloader version (e.g., "1.8.0")
    "mac_address",      // Ethernet MAC address (e.g., "00:1A:2B:3C:4D:5E")
    "ip_address"        // Ethernet IP address (e.g., "192.168.1.100")
  ],
  "correlation_id": "MSG_0001",
  "deadline_s": 30,
  "ts": 1761351123000,
  "expires_at_ms": 1761351150000,
  "reason": "campaign_evaluation"
}
```

## Available fields for VCI request
The `fields` array can contain any combination of the following field names:

| Field Name | Description | Example Value | Required in Response |
|------------|-------------|---------------|---------------------|
| `ecu_id` | ECU identifier | `"ecu_001"`, `"ecu_002"`, ..., `"ecu_100"` | Yes |
| `supplier_code` | Supplier/manufacturer code | `"1234"`, `"5678"` | Recommended |
| `hw_part_no` | Hardware part number | `"HW-PT-0001"` | Yes |
| `sw_part_no` | Software part number | `"SW-PT-4711"` | Recommended |
| `sw_version` | Current software version | `"3.2.5"`, `"10.4.2"` | Yes |
| `calibration_id` | Region/country-specific calibration ID | `"KR-IVI-2025Q1"`, `"CAL-PT-2025-09"` | Recommended |
| `bootloader_ver` | Bootloader version | `"1.8.0"`, `"2.3.0"` | Recommended |
| `mac_address` | Ethernet MAC address | `"00:1A:2B:3C:4D:5E"` | Optional |
| `ip_address` | Ethernet IP address | `"192.168.1.100"` | Optional |

## Deadline and Expiry Processing Rules

### **Priority Order (Highest to Lowest)**
1. **`expires_at_ms`** (absolute expiry) - **Highest Priority**
2. **`deadline_s`** (relative deadline) - **Secondary**
3. **No deadline** - **No time limit**

### **Processing Logic**

#### **Case 1: `expires_at_ms` exists**
- **Action**: VMG checks `current_time > expires_at_ms`
- **If expired**: Discard request (no response) OR send `"EXPIRED"` response
- **If valid**: Process normally, ignore `deadline_s`

#### **Case 2: `expires_at_ms` absent, `deadline_s` exists**
- **Reference time**: Use `ts` (server issue time) if present
- **Fallback**: Use VMG receive time if `ts` absent
- **Calculation**: `expiry_time = reference_time + (deadline_s * 1000)`
- **Action**: VMG checks `current_time > expiry_time`

#### **Case 3: Both absent**
- **Action**: No time limit (use reasonable retry policy)

### **Recommended Response Enhancement**
VMG may optionally include `deadline_hit: true|false` in response to help server determine expiry status.

### **Field Usage Notes**
- `fields` array is **required** and must contain at least one field name
- VMG should return **only the requested fields** (no additional fields)
- VMG may include additional fields not explicitly requested (e.g., `functional_group`)
- Field names are case-sensitive and must match exactly

