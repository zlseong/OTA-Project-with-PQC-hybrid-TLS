# 3. Send VCI (VMG -> Server)

**Spec:** VMG → Server (prototype)

- Format: JSON (flat with small objects)
- Purpose: Send Vehicle Configuration/Inventory (VCI) and minimal power snapshot in response to RequestVCI.

## Fields
- `msg_id` *(string, required)* — e.g., `VMG_MSG_0001`
- `proto_ver` *(string, required)* — e.g., `"1.0"`
- `type` *(string, required)* — fixed: `"SendVCI"`
- `vehicle_id` *(string, required)* — e.g., `VEH_001`
- `gateway_id` *(string, required)* — e.g., `CCU_001`
- `ts` *(int64, required)* — send time (epoch ms UTC)
- `correlation_id` *(string, required)* — link to `RequestVCI.msg_id`

## Correlation ID Usage
- **Purpose**: Links this message to a previous message for request-response matching
- **Value**: Copy the `msg_id` from the triggering message
- **Usage**: Request↔Response matching, retry/duplicate detection, chunk sequence linking, long-term operation result attribution
- **Server Validation**: Verify `correlation_id` matches a valid `msg_id` sent by server, reject if expired (expires_at_ms/deadline_s)
- `region` *(string, recommended)* — e.g., `KR` (for region-specific calibration)
- `fw_sw_version` *(string, required)* — VMG/CCU firmware/software version
- `bootloader_ver` *(string, recommended)* — VMG bootloader version
- `ecu_inventory` *(array, required)* — per-ECU entries; must not be empty
  - `ecu_id` *(string, required)* — e.g., `"ecu_001"`, `"ecu_002"`, ..., `"ecu_100"`
  - `supplier_code` *(string, required)*
  - `hw_part_no` *(string, required)*
  - `sw_part_no` *(string, required)*
  - `sw_version` *(string, required)*
  - `bootloader_ver` *(string, required)*
  - `calibration_id` *(string, required)* — region/country-specific calibration identifier (e.g., `"KR-IVI-2025Q1"`)
  - `mac_address` *(string, conditional)* — Ethernet MAC address (present if ECU has Ethernet interface)
  - `ip_address` *(string, conditional)* — Ethernet IP address (present if ECU has Ethernet interface)
  - `can_id` *(string, conditional)* — CAN bus ID (present if ECU has CAN interface)
  - `functional_group` *(object, required)* — placement metadata (essential for ECU routing)
    - `domain_zone_bit` *(uint)* — 1-bit flag: 0=domain, 1=zone
    - `domain` *(string, conditional)* — e.g., `powertrain|body|chassis|ivi|adas|telematics` (when domain_zone_bit=0)
    - `zone` *(string|int, conditional)* — e.g., `Z2|front_left|2` (when domain_zone_bit=1)
    - `index` *(int, optional)* — sequential order within domain/zone architecture

> **Note**: VCI response is a small JSON message, no chunking needed.
> **Network Interface**: 
> - Ethernet ECUs: `mac_address` and `ip_address` fields
> - CAN Bus ECUs: `can_id` field (e.g., "0x100", "0x200")
> - Mixed ECUs: May have both Ethernet and CAN interfaces

## Example
```json
{
  "msg_id": "VMG_MSG_0001",
  "proto_ver": "1.0",
  "type": "SendVCI",
  "vehicle_id": "VEH_001",
  "gateway_id": "CCU_001",
  "ts": 1761351123000,
  "correlation_id": "SRV_MSG_0001",
  "region": "KR",
  "fw_sw_version": "2.6.1",
  "bootloader_ver": "1.9.0",
  "ecu_inventory": [
    {
      "ecu_id": "ecu_001",
      "supplier_code": "1234",
      "hw_part_no": "HW-PT-0001",
      "sw_part_no": "SW-PT-4711",
      "sw_version": "3.2.5",
      "bootloader_ver": "1.8.0",
      "calibration_id": "CAL-PT-2025-09",
      "mac_address": "00:1A:2B:3C:4D:5E",
      "ip_address": "192.168.1.100",
      "can_id": "0x100",
      "functional_group": { "domain_zone_bit": 0, "domain": "powertrain", "index": 1 }
    },
    {
      "ecu_id": "ecu_002",
      "supplier_code": "5678",
      "hw_part_no": "HW-IVI-010",
      "sw_part_no": "SW-IVI-260",
      "sw_version": "10.4.2",
      "bootloader_ver": "2.3.0",
      "calibration_id": "KR-IVI-2025Q1",
      "mac_address": "00:1A:2B:3C:4D:5F",
      "ip_address": "192.168.1.101",
      "can_id": "0x200",
      "functional_group": { "domain_zone_bit": 1, "zone": "center", "index": 1 }
    }
  ]
}
```

## Field Mapping Rules
- **Strict Mapping**: VMG must return **only** the fields specified in server request
- **No Additional Fields**: Do not include fields not explicitly requested
- **Exception**: `functional_group` is **always included** (essential for ECU routing and architecture understanding)
- **Missing Data**: If requested field data is unavailable, omit the field entirely

## Error Handling Policy
- **Complete VCI Only**: Send VCI response only when **all** requested ECU data is successfully collected
- **Partial Failure**: If any ECU fails to respond, send **error response** instead of partial VCI
- **Retry Logic**: Server should retry the request if VCI collection fails
- **Cost Efficiency**: Avoid sending incomplete data that wastes bandwidth and processing

## Architecture Control Explanation

### **Domain vs Zone Architecture**
- **Domain Architecture** (`domain_zone_bit: 0`): ECU controlled by domain controller
  - **Examples**: Powertrain domain (ECM, TCM, BMS), Body domain (BCM, Door modules)
  - **Control**: Functional grouping by vehicle system
  - **Index**: Sequential order within domain (e.g., powertrain: ECM=1, TCM=2, BMS=3)

- **Zone Architecture** (`domain_zone_bit: 1`): ECU controlled by zonal controller  
  - **Examples**: Front-left zone (sensors, actuators), Center zone (IVI, HVAC)
  - **Control**: Physical location grouping by vehicle zone
  - **Index**: Sequential order within zone (e.g., front_left: sensor1=1, sensor2=2)

### **Index Field Usage**
- **Purpose**: Indicates ECU's position within its controlling architecture
- **Range**: 1-255 (0 reserved for unknown/unassigned)
- **Usage**: Helps identify ECU hierarchy and communication order within domain/zone

### **Why functional_group is Required**
- **ECU Routing**: Server needs to know which ZCU/DCU controls each ECU
- **Command Path**: Determines the correct path for sending update commands
- **Architecture Awareness**: Essential for understanding vehicle's domain/zone structure
- **Update Planning**: Required for determining which ECUs can be updated together

## Validation & rules
- `ecu_inventory` must contain ≥1 item.
- If present, `correlation_id` must match an outstanding `RequestVCI.msg_id`.
- `vehicle_id`/`gateway_id` must match the current binding.
- **Field Compliance**: Only include fields explicitly requested by server
- **Data Completeness**: All requested ECU data must be successfully collected

