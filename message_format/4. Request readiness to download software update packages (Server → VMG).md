# 4. Request readiness to download software update packages (Server → VMG)

**Spec:** Server → VMG (prototype)

- Format: JSON (flat)
- Purpose: Ask VMG to evaluate whether it can start downloading specified update packages now. (Not a start-download command.)

## Minimal fields
- `msg_id` *(string, required)* — e.g., `SRV_MSG_0101`
- `proto_ver` *(string, required)* — e.g., `"1.0"`
- `type` *(string, required)* — fixed: `"RequestDownloadReadiness"`
- `vehicle_id` *(string, required)* — e.g., `VEH_001`
- `gateway_id` *(string, required)* — e.g., `CCU_001`
- `ts` *(int64, optional)* — send time (epoch ms UTC)
- `correlation_id` *(string, optional)* — link to SendVCI.msg_id

## Correlation ID Usage
- **Purpose**: Links this message to a previous message for request-response matching
- **Value**: Copy the `msg_id` from the triggering message
- **Usage**: Request↔Response matching, retry/duplicate detection, chunk sequence linking, long-term operation result attribution
- **Server Validation**: Verify `correlation_id` matches a valid `msg_id` sent by server, reject if expired (expires_at_ms/deadline_s)
- `region_filter` *(string, optional)* — filter packages by region (e.g., "KR", "US", "EU")
- `packages` *(array, required)* — list of packages to evaluate
  - `pkg_id` *(string, required)*
  - `target_component` *(string, required)*
  - `target_version` *(string, required)*
  - `size_bytes` *(uint64, required)*
  - `hash_sha256` *(string, optional)*
  - `delta_from` *(string, optional)* — base version; if omitted, treat as full image
- `transfer` *(object, required)*
  - `protocol` *(string, required)* — fixed: `"HTTPS"` (mandatory for security)
  - `allow_chunking` *(bool, required)* — enable chunked file transfer for large update files
  - `max_kb_per_msg` *(uint, required)* — maximum chunk size for HTTPS file transfer
- `readiness_requirements` *(array[string], required)* — keys VMG must return (e.g., power/thermal)

## Example
```json
{
  "msg_id": "SRV_MSG_0101",
  "proto_ver": "1.0",
  "type": "RequestDownloadReadiness",
  "vehicle_id": "VEH_001",
  "gateway_id": "CCU_001",
  "ts": 1761351200000,
  "correlation_id": "SRV_MSG_0001",
  "region_filter": "KR",
  "packages": [
    {
      "pkg_id": "PKG-ecu_001-3.2.5-delta-3.1.4",
      "target_component": "ecu_001-SW",
      "target_version": "3.2.5",
      "delta_from": "3.1.4",
      "size_bytes": 14562342,
      "hash_sha256": "3f8b...d2"
    },
    {
      "pkg_id": "PKG-ecu_002-MAP-2025Q4",
      "target_component": "ecu_002-MAP-DATA",
      "target_version": "2025.4",
      "size_bytes": 104857600,
      "hash_sha256": "ab19...77"
    }
  ],
  "transfer": {
    "protocol": "HTTPS",
    "allow_chunking": true,
    "max_kb_per_msg": 64
  },
  "readiness_requirements": [
    "power.battery_12v_v",
    "thermal.temp_ccu_c",
    "cpu.usage_percent",
    "memory.available_mb",
    "network.bandwidth_mbps",
    "vehicle.speed_kmh"
  ]
}
```

## Available Readiness Requirements
VMG can monitor and report the following system conditions:

### **Power & Energy**
- `power.battery_12v_v` - 12V 배터리 전압
- `power.battery_48v_v` - 48V 배터리 전압 (하이브리드/전기차)
- `power.charging_status` - 충전 상태 (충전 중/완료/미충전)

### **Thermal Management**
- `thermal.temp_ccu_c` - CCU 온도
- `thermal.temp_ecu_max_c` - 가장 높은 ECU 온도

### **System Resources**
- `cpu.usage_percent` - 현재 CPU 사용률
- `memory.available_mb` - 사용 가능한 메모리 (MB)
- `storage.available_gb` - 사용 가능한 저장공간 (GB)

### **Network & Communication**
- `network.bandwidth_mbps` - 현재 네트워크 대역폭
- `network.signal_strength` - 셀룰러 신호 강도
- `network.data_plan_status` - 데이터 요금제 상태

### **Vehicle Status**
- `vehicle.speed_kmh` - 현재 주행 속도
- `vehicle.ignition_status` - 시동 상태
- `vehicle.parking_brake` - 주차 브레이크 상태
- `vehicle.gear_position` - 기어 위치 (P/R/N/D)

## Delta Package Processing Rules
- **Version Match**: If `delta_from` matches current ECU version → Ready for delta
- **Version Mismatch**: If `delta_from` doesn't match → Request full image instead
- **Unknown Version**: If current version cannot be determined → Request full image
- **Fallback Policy**: Always prefer full image over failed delta to ensure reliability

## Notes
- This message requests an evaluation only; actual download begins after a separate command
- VMG must receive ALL packages before proceeding to installation phase
- HTTPS is mandatory for security in cellular network environment
- **Chunking**: Only applies to HTTPS file transfer, not MQTT control messages
- **File Transfer**: Large update files (MB~GB) are transferred via HTTPS with chunking
- **Control Messages**: Small JSON messages (KB) are sent via MQTT without chunking
- **Region Filter**: Server uses `region_filter` to select region-specific packages based on VMG's `region` from SendVCI

