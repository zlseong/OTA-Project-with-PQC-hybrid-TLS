# 5. Send ready response (VMG → Server)

**Spec:** VMG → Server (prototype)

- Format: JSON (flat)
- Purpose: Report overall vehicle readiness to begin downloading software updates

## Fields
- `msg_id` *(string, required)* — e.g., `VMG_MSG_0201`
- `proto_ver` *(string, required)* — e.g., `"1.0"`
- `type` *(string, required)* — fixed: `"ReadinessReportForDownload"`
- `vehicle_id` *(string, required)* — e.g., `VEH_001`
- `gateway_id` *(string, required)* — e.g., `CCU_001`
- `ts` *(int64, required)* — send time (epoch ms UTC)
- `correlation_id` *(string, required)* — must match the server request `msg_id`

## Correlation ID Usage
- **Purpose**: Links this message to a previous message for request-response matching
- **Value**: Copy the `msg_id` from the triggering message
- **Usage**: Request↔Response matching, retry/duplicate detection, chunk sequence linking, long-term operation result attribution
- **Server Validation**: Verify `correlation_id` matches a valid `msg_id` sent by server, reject if expired (expires_at_ms/deadline_s)
- `ready` *(bool, required)* — overall vehicle readiness to start download
- `requested_fields` *(object, required)* — current values of system conditions requested by server
- `not_ready_reasons` *(array[string], optional)* — empty if ready, present if ready==false
- `retry_after_s` *(uint, optional)* — backoff hint if not ready

## Example — ready
```json
{
  "msg_id": "VMG_MSG_0201",
  "proto_ver": "1.0",
  "type": "ReadinessReportForDownload",
  "vehicle_id": "VEH_001",
  "gateway_id": "CCU_001",
  "ts": 1761351215000,
  "correlation_id": "SRV_MSG_0101",
  "ready": true,
  "requested_fields": {
    "power.battery_12v_v": 12.4,
    "thermal.temp_ccu_c": 36,
    "cpu.usage_percent": 45,
    "memory.available_mb": 2048,
    "network.bandwidth_mbps": 15.2,
    "vehicle.speed_kmh": 0
  }
}
```

## Example — not ready (low power)
```json
{
  "msg_id": "VMG_MSG_0202",
  "proto_ver": "1.0",
  "type": "ReadinessReportForDownload",
  "vehicle_id": "VEH_001",
  "gateway_id": "CCU_001",
  "ts": 1761351220000,
  "correlation_id": "SRV_MSG_0101",
  "ready": false,
  "requested_fields": {
    "power.battery_12v_v": 11.9,
    "thermal.temp_ccu_c": 38,
    "cpu.usage_percent": 75,
    "memory.available_mb": 512,
    "network.bandwidth_mbps": 2.1,
    "vehicle.speed_kmh": 0
  },
  "not_ready_reasons": ["POWER_LOW", "MEMORY_LOW"],
  "retry_after_s": 1800
}
```

## Complete Not Ready Reason Codes

### **Power & Energy**
- `POWER_LOW` - 배터리 전압 부족 (12V < 11.5V)
- `POWER_CHARGING` - 충전 중 (충전 완료 후 가능)
- `POWER_CRITICAL` - 배터리 위험 수준

### **Thermal**
- `TEMP_HIGH` - 온도 과열 (CCU > 70°C)
- `TEMP_COOLING` - 냉각 중
- `TEMP_CRITICAL` - 임계 온도 초과 (> 85°C)

### **System Resources**
- `CPU_HIGH` - CPU 사용률 과부하 (> 80%)
- `MEMORY_LOW` - 메모리 부족 (< 1GB)
- `STORAGE_LOW` - 저장공간 부족 (< 2GB)
- `STORAGE_FRAGMENTED` - 저장공간 조각화

### **Network**
- `NETWORK_POOR` - 네트워크 품질 불량 (< 1Mbps)
- `NETWORK_DATA_LIMIT` - 데이터 한도 초과
- `NETWORK_ROAMING` - 로밍 상태

### **Vehicle Status**
- `VEHICLE_MOVING` - 주행 중 (정차 후 가능)
- `VEHICLE_HIGH_SPEED` - 고속 주행 중 (> 60km/h)
- `VEHICLE_EMERGENCY` - 비상 상황

## Retry After Guidelines
- **Minimum**: 60 seconds (1분)
- **Maximum**: 7200 seconds (2시간)
- **Recommended ranges**:
  - Power issues: 1800-3600s (30분-1시간)
  - Thermal issues: 300-1800s (5분-30분)
  - Network issues: 60-600s (1분-10분)
  - Vehicle status: 60-1800s (1분-30분)

## Notes
- `ready=true`: 차량 전체가 다운로드 준비 완료
- `ready=false`: 차량 상태로 인해 다운로드 불가
- VMG는 차량 시스템 상태를 종합 판단하여 준비 여부 결정
- **Next Step**: Server receives `ready=true` → sends download start command → VMG begins HTTPS file transfer

